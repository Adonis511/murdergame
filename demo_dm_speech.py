#!/usr/bin/env python3
"""
DMå‘è¨€ç³»ç»Ÿæ¼”ç¤º
å±•ç¤ºåœ¨å®é™…æ¸¸æˆä¸­å¦‚ä½•ä½¿ç”¨DMå‘è¨€åŠŸèƒ½
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from game import Game

def simulate_game_session():
    """æ¨¡æ‹Ÿä¸€ä¸ªå®Œæ•´çš„æ¸¸æˆä¼šè¯ï¼Œå±•ç¤ºDMå‘è¨€çš„å„ç§åœºæ™¯"""
    print("ğŸ­ å‰§æœ¬æ€DMå‘è¨€ç³»ç»Ÿæ¼”ç¤º")
    print("=" * 60)
    
    # åˆ›å»ºæ¸¸æˆï¼ˆä¸ç”Ÿæˆå›¾ç‰‡ï¼ŒèŠ‚çœæ—¶é—´ï¼‰
    print("ğŸ“ æ­£åœ¨åˆ›å»ºæ–°æ¸¸æˆ...")
    game = Game(script_path=None, generate_images=False)
    
    print(f"\nâœ… æ¸¸æˆåˆ›å»ºæˆåŠŸ!")
    print(f"ğŸ¯ å‰§æœ¬: {game.script.get('title', 'æœªå‘½åå‰§æœ¬')}")
    print(f"ğŸ‘¥ è§’è‰²: {', '.join(game.script.get('characters', []))}")
    print(f"ğŸ“– ç« èŠ‚æ•°: {game.get_total_chapters()}")
    
    # æ¨¡æ‹Ÿæ¸¸æˆæµç¨‹
    chat_history = ""
    
    # ç¬¬1ç« å¼€å§‹
    print("\n" + "="*50)
    print("ğŸ“– ç¬¬1ç« ï¼šæ¸¸æˆå¼€å§‹")
    print("="*50)
    
    dm_speech = game.start_chapter(1, chat_history)
    print(f"\nğŸ­ DM: {dm_speech}\n")
    
    # æ¨¡æ‹Ÿç©å®¶å¯¹è¯
    chat_history += f"""
DM: {dm_speech}

æå: å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯æåã€‚è¿™æ¬¡èšä¼šçœŸæ˜¯è®©äººæ„å¤–...
ç‹å¼º: æ˜¯å•Šï¼Œæ²¡æƒ³åˆ°ä¼šå‘ç”Ÿè¿™ç§äº‹æƒ…ã€‚æˆ‘ä»¬éœ€è¦å†·é™åˆ†æã€‚
å¼ é›ª: æˆ‘è§‰å¾—æˆ‘ä»¬åº”è¯¥å…ˆæ£€æŸ¥ä¸€ä¸‹ç°åœºï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆçº¿ç´¢ã€‚
æå: åŒæ„ï¼Œè®©æˆ‘ä»¬åˆ†å¤´è¡ŒåŠ¨ï¼Œä»”ç»†å¯»æ‰¾è¯æ®ã€‚
ç‹å¼º: ç­‰ç­‰ï¼Œåœ¨åˆ†å¼€ä¹‹å‰ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯åº”è¯¥å…ˆè¯´è¯´è‡ªå·±æ˜¨æ™šçš„è¡Œè¸ªï¼Ÿ
"""
    
    print("ğŸ’¬ ç©å®¶å¯¹è¯:")
    print(chat_history.split("DM:")[1].strip())
    
    # DMç©¿æ’å‘è¨€
    print("\n" + "-"*30)
    print("ğŸ­ DMç©¿æ’å‘è¨€ç¤ºä¾‹")
    print("-"*30)
    
    dm_interject = game.dm_interject(
        chat_history=chat_history,
        trigger_reason="å¼•å¯¼ç©å®¶è¿›è¡Œæ›´æ·±å…¥çš„è°ƒæŸ¥",
        guidance="æé†’ç©å®¶æ³¨æ„æ—¶é—´çº¿å’ŒåŠ¨æœº"
    )
    print(f"\nğŸ­ DM: {dm_interject}\n")
    
    # ç»§ç»­æ¨¡æ‹Ÿå¯¹è¯
    chat_history += f"""
DM: {dm_interject}

å¼ é›ª: DMè¯´å¾—å¯¹ï¼Œæˆ‘ä»¬ç¡®å®éœ€è¦å»ºç«‹æ—¶é—´çº¿ã€‚
æå: æˆ‘æ˜¨æ™š10ç‚¹å°±å›æˆ¿é—´ä¼‘æ¯äº†ï¼Œæœ‰äººå¯ä»¥è¯æ˜å—ï¼Ÿ
ç‹å¼º: æˆ‘å’Œå¼ é›ªä¸€èµ·åœ¨å®¢å…èŠå¤©åˆ°11ç‚¹åŠã€‚
å¼ é›ª: æ˜¯çš„ï¼Œç„¶åæˆ‘ä»¬å°±å„è‡ªå›æˆ¿äº†ã€‚
æå: é‚£æ¡ˆå‘æ—¶é—´æ˜¯ä»€ä¹ˆæ—¶å€™ï¼Ÿ
ç‹å¼º: æ ¹æ®ç°åœºæƒ…å†µï¼Œåº”è¯¥æ˜¯å‡Œæ™¨2ç‚¹å·¦å³ã€‚
"""
    
    # ç¬¬1ç« ç»“æŸ
    print("ğŸ“– ç¬¬1ç« å³å°†ç»“æŸ...")
    dm_end_chapter = game.end_chapter(1, chat_history)
    print(f"\nğŸ­ DM: {dm_end_chapter}\n")
    
    # ç¬¬2ç« å¼€å§‹
    print("\n" + "="*50)
    print("ğŸ“– ç¬¬2ç« ï¼šæ·±å…¥è°ƒæŸ¥")
    print("="*50)
    
    dm_chapter2 = game.start_chapter(2, chat_history)
    print(f"\nğŸ­ DM: {dm_chapter2}\n")
    
    # æ¨¡æ‹Ÿæ›´å¤šå¯¹è¯å’Œçº¿ç´¢å‘ç°
    final_history = chat_history + f"""
DM: {dm_end_chapter}
DM: {dm_chapter2}

æå: æˆ‘åœ¨ä¹¦æˆ¿å‘ç°äº†ä¸€æŠŠåˆ€ï¼
ç‹å¼º: ä»€ä¹ˆï¼Ÿåœ¨å“ªé‡Œï¼Ÿ
å¼ é›ª: è¿™å¯èƒ½å°±æ˜¯å‡¶å™¨ï¼
æå: åˆ€ä¸Šè¿˜æœ‰è¡€è¿¹ï¼Œè€Œä¸”åˆ€æŸ„ä¸Šæœ‰æŒ‡çº¹ã€‚
ç‹å¼º: æˆ‘ä»¬éœ€è¦å¯¹æ¯”æŒ‡çº¹ã€‚è¿˜æœ‰åˆ«çš„å‘ç°å—ï¼Ÿ
å¼ é›ª: æˆ‘åœ¨èµ°å»Šå‘ç°äº†è„šå°ï¼Œé€šå‘å¼ ä¸‰çš„æˆ¿é—´ã€‚
æå: ç­‰ç­‰ï¼Œå¼ ä¸‰ä¸æ˜¯å—å®³è€…å—ï¼Ÿ
ç‹å¼º: å¯¹ï¼Œæ‰€ä»¥å‡¶æ‰‹å¯èƒ½æ˜¯ä»ä»–æˆ¿é—´é€ƒè·‘çš„ã€‚
å¼ é›ª: æˆ–è€…å‡¶æ‰‹å°±ä½åœ¨é‚£é™„è¿‘...
æå: æˆ‘è§‰å¾—æˆ‘ä»¬å·²ç»æ¥è¿‘çœŸç›¸äº†ï¼
ç‹å¼º: ç»è¿‡æ¨ç†ï¼Œæˆ‘è®¤ä¸ºå‡¶æ‰‹æ˜¯ç®¡å®¶ï¼
å¼ é›ª: æˆ‘ä¹Ÿè¿™ä¹ˆè®¤ä¸ºï¼Œè¯æ®éƒ½æŒ‡å‘ä»–ã€‚
"""
    
    # æ¸¸æˆç»“æŸ
    print("\n" + "="*50)
    print("ğŸ‰ æ¸¸æˆç»“æŸï¼šçœŸç›¸å¤§ç™½")
    print("="*50)
    
    # æ¨¡æ‹Ÿæ¸¸æˆç»“æŸæ—¶çš„æœ€ç»ˆæ€»ç»“
    dm_final = game.end_game(
        chat_history=final_history,
        killer="ç®¡å®¶çº¦ç¿°",
        truth_info="çº¦ç¿°å‘ç°ä¸»äººè¦ä¿®æ”¹é—å˜±ï¼Œå‰¥å¤ºä»–çš„ç»§æ‰¿æƒï¼Œæ„¤æ€’ä¹‹ä¸‹ç”¨å¤è‘£åŒ•é¦–æ€å®³äº†ä¸»äººï¼Œå¹¶è¯•å›¾ä¼ªé€ ç°åœºã€‚"
    )
    print(f"\nğŸ­ DMæœ€ç»ˆæ€»ç»“: {dm_final}\n")
    
    # å±•ç¤ºè§¦å‘æ¡ä»¶æµ‹è¯•
    print("\n" + "="*50)
    print("ğŸ¯ DMå‘è¨€è§¦å‘æ¡ä»¶æ¼”ç¤º")
    print("="*50)
    
    test_scenarios = [
        {
            "æè¿°": "æ­£å¸¸æ¸¸æˆå¯¹è¯",
            "å†å²": "ç©å®¶A: æˆ‘è§‰å¾—çº¿ç´¢å¾ˆæœ‰ç”¨ã€‚ç©å®¶B: æ˜¯çš„ï¼Œæˆ‘ä»¬ç»§ç»­è°ƒæŸ¥ã€‚",
            "æ¶ˆæ¯æ•°": 5
        },
        {
            "æè¿°": "åŒ…å«å…³é”®è¯çš„è®¨è®º",
            "å†å²": "ç©å®¶A: æˆ‘æ€€ç–‘å‡¶æ‰‹å°±åœ¨è¿™é‡Œï¼ç©å®¶B: æœ‰ä»€ä¹ˆè¯æ®æ”¯æŒä½ çš„æ¨ç†ï¼Ÿç©å®¶C: çœŸç›¸å³å°†æ­æ™“ï¼",
            "æ¶ˆæ¯æ•°": 6
        },
        {
            "æè¿°": "æ¶ˆæ¯è¿‡å¤šéœ€è¦å¼•å¯¼",
            "å†å²": "ç©å®¶ä»¬åœ¨è®¨è®ºæ— å…³è¯é¢˜...",
            "æ¶ˆæ¯æ•°": 12
        }
    ]
    
    for scenario in test_scenarios:
        should_speak = game.should_dm_interject(
            chat_history=scenario["å†å²"],
            message_count_since_last_dm=scenario["æ¶ˆæ¯æ•°"]
        )
        status = "âœ… éœ€è¦å‘è¨€" if should_speak else "âŒ æ— éœ€å‘è¨€"
        print(f"{scenario['æè¿°']}: {status}")
    
    print("\n" + "="*60)
    print("ğŸ‰ DMå‘è¨€ç³»ç»Ÿæ¼”ç¤ºå®Œæˆï¼")
    print("="*60)
    
    print(f"\nğŸ“Š æ¸¸æˆç»Ÿè®¡:")
    print(f"  æ¸¸æˆç›®å½•: {game.get_game_directory()}")
    print(f"  å‰§æœ¬æ ‡é¢˜: {game.script.get('title', 'æœªå‘½åå‰§æœ¬')}")
    print(f"  æ€»ç« èŠ‚æ•°: {game.get_total_chapters()}")
    print(f"  è§’è‰²æ•°é‡: {len(game.script.get('characters', []))}")
    
    print(f"\nğŸ’¡ åŠŸèƒ½ç‰¹ç‚¹:")
    print(f"  âœ… æ™ºèƒ½ç« èŠ‚å¼•å¯¼å‘è¨€")
    print(f"  âœ… ç« èŠ‚æ€»ç»“å’Œè¿‡æ¸¡")
    print(f"  âœ… æ¸¸æˆç»“æŸçœŸç›¸æ­ç¤º")
    print(f"  âœ… åŠ¨æ€ç©¿æ’å‘è¨€")
    print(f"  âœ… è‡ªåŠ¨è§¦å‘æ¡ä»¶åˆ¤æ–­")
    print(f"  âœ… ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„ä¸ªæ€§åŒ–å†…å®¹")

if __name__ == "__main__":
    simulate_game_session()