{% extends "base.html" %}

{% block title %}å‰§æœ¬æ€æ¸¸æˆå¤§å… - æ¨ç†ä¹‹å¤œ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='murder_mystery_v2.css') }}">
<!-- å¼•å…¥å¿…è¦çš„åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<style>
    body {
        background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0f0f0f 100%);
        color: #e0e0e0;
        font-family: 'Georgia', 'Times New Roman', serif;
        overflow: hidden;
    }
    
    /* è¦†ç›–å¯¼èˆªæ æ ·å¼ */
    .navbar {
        background: rgba(0, 0, 0, 0.9) !important;
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #8B0000;
        position: fixed !important;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
    }
    
    main {
        padding: 0;
        height: 100vh;
        padding-top: 70px;
    }
    
    /* æ‚¬ç–‘èƒŒæ™¯åŠ¨ç”» */
    .mystery-bg {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            radial-gradient(circle at 20% 80%, rgba(139, 0, 0, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 20%, rgba(75, 0, 130, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 40%, rgba(0, 0, 0, 0.3) 0%, transparent 50%);
        animation: mysteriousGlow 10s ease-in-out infinite alternate;
        z-index: -1;
    }
    
    @keyframes mysteriousGlow {
        0% { opacity: 0.3; }
        100% { opacity: 0.7; }
    }
    
    /* é›¾æ°”æ•ˆæœ */
    .fog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.02) 50%, transparent 70%),
            linear-gradient(-45deg, transparent 30%, rgba(255,255,255,0.01) 50%, transparent 70%);
        animation: fog 20s linear infinite;
        pointer-events: none;
        z-index: 1;
    }
    
    @keyframes fog {
        0% { transform: translateX(-100%) translateY(-100%); }
        100% { transform: translateX(100%) translateY(100%); }
    }
</style>
{% endblock %}

{% block content %}
<!-- æ‚¬ç–‘èƒŒæ™¯ -->
<div class="mystery-bg"></div>
<div class="fog-overlay"></div>

<div class="murder-mystery-container">
    <!-- æ¸¸æˆçŠ¶æ€æ  -->
    <div class="game-status-bar">
        <div class="game-info">
            <div class="story-title">
                <h3 id="storyTitle">ğŸ“š ç­‰å¾…å‰§æœ¬åŠ è½½...</h3>
                <span class="story-subtitle" id="storySubtitle">ç¥ç§˜æ•…äº‹å³å°†å¼€å§‹</span>
            </div>
            <div class="chapter-info">
                <span class="chapter-indicator" id="chapterIndicator">å‡†å¤‡é˜¶æ®µ</span>
                <span class="progress-bar">
                    <span class="progress-fill" id="progressFill" style="width: 0%"></span>
                </span>
            </div>
        </div>
        <div class="game-controls">
            <button class="mystery-btn" id="newGameBtn" onclick="startNewGame()">
                ğŸ­ æ–°æ¸¸æˆ
            </button>
            <button class="mystery-btn" id="loadGameBtn" onclick="loadExistingGame()">
                ğŸ“‚ åŠ è½½æ¸¸æˆ
            </button>
            <button class="mystery-btn" id="configBtn" onclick="showGameConfig()">
                âš™ï¸ é…ç½®
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆé…ç½®é¢æ¿ -->
    <div class="config-panel" id="configPanel" style="display: none;">
        <h4>ğŸ® æ¸¸æˆé…ç½®</h4>
        <div class="config-options">
            <div class="config-group">
                <label>å‰§æœ¬æ¥æºï¼š</label>
                <div class="radio-group">
                    <label><input type="radio" name="scriptSource" value="generate" checked> ğŸ†• AIç”Ÿæˆæ–°å‰§æœ¬</label>
                    <label><input type="radio" name="scriptSource" value="local"> ğŸ“ ä½¿ç”¨æœ¬åœ°å‰§æœ¬</label>
                </div>
            </div>
            <div class="config-group" id="localPathGroup" style="display: none;">
                <label>æœ¬åœ°å‰§æœ¬è·¯å¾„ï¼š</label>
                <input type="text" id="localScriptPath" placeholder="è¾“å…¥å‰§æœ¬æ–‡ä»¶å¤¹è·¯å¾„ï¼Œå¦‚: log/250805151240">
                <button class="browse-btn" onclick="browseLocalScripts()">æµè§ˆ</button>
            </div>
            <div class="config-group">
                <label><input type="checkbox" id="generateImages" checked> ğŸ–¼ï¸ ç”Ÿæˆè§’è‰²å’Œçº¿ç´¢å›¾ç‰‡</label>
                <small>æ³¨æ„ï¼šç”Ÿæˆå›¾ç‰‡éœ€è¦é¢å¤–æ—¶é—´ï¼Œä½†ä½“éªŒæ›´ä½³</small>
            </div>
            <div class="config-group">
                <label><input type="checkbox" id="waitForCompletion" checked> â³ ç­‰å¾…æ‰€æœ‰å†…å®¹ç”Ÿæˆå®Œæˆ</label>
                <small>ç¡®ä¿å‰§æƒ…ã€å›¾ç‰‡ç­‰æ‰€æœ‰å†…å®¹å‡†å¤‡å°±ç»ªåå†å¼€å§‹</small>
            </div>
        </div>
        <div class="config-actions">
            <button class="mystery-btn cancel-btn" onclick="hideGameConfig()">å–æ¶ˆ</button>
            <button class="mystery-btn confirm-btn" onclick="applyGameConfig()">åº”ç”¨é…ç½®</button>
        </div>
    </div>

    <!-- è§’è‰²é€‰æ‹©é¢æ¿ -->
    <div class="character-panel" id="characterPanel" style="display: none;">
        <h4>ğŸ­ é€‰æ‹©ä½ çš„è§’è‰²</h4>
        <div class="character-grid" id="characterGrid">
            <!-- è§’è‰²å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <button class="mystery-btn confirm-btn" id="confirmCharacterBtn" onclick="confirmCharacterSelection()" disabled>
            ç¡®è®¤è§’è‰²é€‰æ‹©
        </button>
    </div>

    <!-- ä¸»æ¸¸æˆåŒºåŸŸ - ä¸‰åˆ—å¸ƒå±€ -->
    <div class="main-game-area" id="mainGameArea" style="display: none;">
        <!-- å·¦ä¾§é¢æ¿ï¼šç©å®¶åˆ—è¡¨å’ŒçŠ¶æ€ -->
        <div class="left-sidebar">
            <div class="player-info-panel">
                <h4>ğŸ‘¤ æˆ‘çš„è§’è‰²</h4>
                <div class="my-character">
                    <div class="character-avatar" id="myAvatar">ğŸ­</div>
                    <div class="character-details">
                        <div class="character-name" id="myCharacterName">è§’è‰²åç§°</div>
                        <div class="player-name">{{ user.nickname }}</div>
                        <div class="character-status" id="myStatus">å‡†å¤‡ä¸­</div>
                    </div>
                </div>
            </div>

            <div class="players-panel">
                <h4>ğŸ‘¥ å…¶ä»–ç©å®¶</h4>
                <div class="players-list" id="playersList">
                    <!-- åŠ¨æ€ç”Ÿæˆç©å®¶åˆ—è¡¨ -->
                </div>
            </div>

            <div class="game-stats-panel">
                <h4>ğŸ“Š æ¸¸æˆç»Ÿè®¡</h4>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">ç« èŠ‚</span>
                        <span class="stat-value" id="currentChapter">0/0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">çº¿ç´¢</span>
                        <span class="stat-value" id="clueCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">æ—¶é—´</span>
                        <span class="stat-value" id="gameTime">00:00</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">å‘è¨€</span>
                        <span class="stat-value" id="messageCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¸­å¤®ä¸»åŒºåŸŸï¼šèŠå¤©æ¶ˆæ¯ -->
        <div class="center-main">
            <div class="game-messages" id="gameMessages">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="message welcome-message">
                    <div class="message-header">
                        <span class="speaker-icon">ğŸ­</span>
                        <span class="speaker-name">æ¸¸æˆä¸»æŒ</span>
                        <span class="message-time">{{ format_datetime(datetime.utcnow()) }}</span>
                    </div>
                    <div class="message-content">
                        <h3>ğŸŒ™ æ¬¢è¿æ¥åˆ°æ¨ç†ä¹‹å¤œ</h3>
                        <p>æ¬¢è¿æ¥åˆ°è¿™ä¸ªå……æ»¡è°œå›¢çš„ä¸–ç•Œï¼Œ<strong>{{ user.nickname }}</strong>ã€‚</p>
                        <div class="mystery-quote">
                            <em>"çœŸç›¸æ€»æ˜¯éšè—åœ¨æœ€ä¸èµ·çœ¼çš„åœ°æ–¹ï¼Œè€Œå‡¶æ‰‹å¯èƒ½å°±åœ¨ä½ èº«è¾¹..."</em>
                        </div>
                        <p>åœ¨è¿™é‡Œï¼Œä½ å°†ï¼š</p>
                        <ul>
                            <li>ğŸ” <strong>æ‰®æ¼”è§’è‰²</strong> - æ²‰æµ¸åœ¨ç²¾å¿ƒè®¾è®¡çš„äººç‰©èƒŒæ™¯ä¸­</li>
                            <li>ğŸ•µï¸ <strong>æ”¶é›†çº¿ç´¢</strong> - åœ¨å¯¹è¯ä¸­å¯»æ‰¾çœŸç›¸çš„è››ä¸é©¬è¿¹</li>
                            <li>ğŸ’­ <strong>æ¨ç†åˆ†æ</strong> - è¿ç”¨é€»è¾‘æ­å¼€è°œå›¢</li>
                            <li>âš¡ <strong>å®æ—¶äº’åŠ¨</strong> - ä¸å…¶ä»–ç©å®¶è¿›è¡ŒçœŸå®çš„è§’è‰²æ‰®æ¼”</li>
                        </ul>
                        <div class="warning-box">
                            âš ï¸ <strong>æ³¨æ„</strong>ï¼šæ¯ä¸ªäººéƒ½æœ‰ç§˜å¯†ï¼ŒåŒ…æ‹¬ä½ è‡ªå·±ã€‚è¯·ä»”ç»†é˜…è¯»è§’è‰²å‰§æœ¬ï¼Œä¿å®ˆç§˜å¯†ï¼ŒçœŸå®æ‰®æ¼”ã€‚
                        </div>
                        <p class="game-tip">ğŸ’¡ ç‚¹å‡»ä¸Šæ–¹ <strong>"é…ç½®"</strong> è®¾ç½®æ¸¸æˆå‚æ•°ï¼Œç„¶å <strong>"æ–°æ¸¸æˆ"</strong> å¼€å§‹ä½ çš„æ¨ç†ä¹‹æ—…...</p>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="game-input-area" id="gameInputArea">
                <div class="input-container">
                    <div class="input-header">
                        <span class="input-mode" id="inputMode">ğŸ’¬ è‡ªç”±å‘è¨€</span>
                        <div class="input-options">
                            <button class="input-option active" id="speakBtn" onclick="setInputMode('speak')" title="è‡ªç”±å‘è¨€">
                                ğŸ’¬
                            </button>
                            <button class="input-option" id="askBtn" onclick="setInputMode('ask')" title="è¯¢é—®ä»–äºº">
                                â“
                            </button>
                            <button class="input-option" id="whisperBtn" onclick="setInputMode('whisper')" title="ç§èŠ">
                                ğŸ¤«
                            </button>
                            <button class="input-option" id="actionBtn" onclick="setInputMode('action')" title="è¡ŒåŠ¨æè¿°">
                                ğŸ¬
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¯¢é—®ç›®æ ‡é€‰æ‹© -->
                    <div class="ask-target" id="askTarget" style="display: none;">
                        <label>è¯¢é—®å¯¹è±¡ï¼š</label>
                        <select id="askTargetSelect">
                            <option value="">é€‰æ‹©è¦è¯¢é—®çš„äºº...</option>
                        </select>
                    </div>
                    
                    <!-- ç§èŠç›®æ ‡é€‰æ‹© -->
                    <div class="whisper-target" id="whisperTarget" style="display: none;">
                        <label>ç§èŠå¯¹è±¡ï¼š</label>
                        <select id="whisperTargetSelect">
                            <option value="">é€‰æ‹©ç§èŠå¯¹è±¡...</option>
                        </select>
                    </div>
                    
                    <textarea 
                        id="messageInput" 
                        placeholder="è¯·è¾“å…¥ä½ çš„å‘è¨€å†…å®¹... (æ”¯æŒMarkdownæ ¼å¼)"
                        rows="3"
                    ></textarea>
                    
                    <div class="input-footer">
                        <div class="input-stats">
                            <span id="charCount">0/500</span>
                            <span class="typing-indicator" id="typingIndicator" style="display: none;">
                                å¯¹æ–¹æ­£åœ¨è¾“å…¥...
                            </span>
                        </div>
                        <button id="sendBtn" class="send-btn" disabled>
                            <span class="btn-icon">ğŸ“¤</span>
                            <span class="btn-text">å‘é€</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§é¢æ¿ï¼šå‰§æœ¬å’Œå·¥å…· -->
        <div class="right-sidebar">
            <div class="script-panel">
                <h4>ğŸ“œ æˆ‘çš„å‰§æœ¬</h4>
                <div class="script-tabs">
                    <button class="script-tab active" data-chapter="all" onclick="showScriptChapter('all')">å…¨éƒ¨</button>
                    <button class="script-tab" data-chapter="1" onclick="showScriptChapter(1)">ç¬¬1ç« </button>
                    <button class="script-tab" data-chapter="2" onclick="showScriptChapter(2)">ç¬¬2ç« </button>
                    <button class="script-tab" data-chapter="3" onclick="showScriptChapter(3)">ç¬¬3ç« </button>
                </div>
                <div class="script-content" id="scriptContent">
                    <div class="script-placeholder">
                        é€‰æ‹©è§’è‰²åå°†æ˜¾ç¤ºæ‚¨çš„å‰§æœ¬å†…å®¹...
                    </div>
                </div>
            </div>

            <div class="tools-panel">
                <h4>ğŸ”§ æ¸¸æˆå·¥å…·</h4>
                <div class="tools-grid">
                    <button class="tool-btn" id="clueBtn" title="æŸ¥çœ‹çº¿ç´¢" onclick="showClues()">
                        <span class="tool-icon">ğŸ”</span>
                        <span class="tool-label">çº¿ç´¢</span>
                        <span class="badge" id="clueBadge">0</span>
                    </button>
                    
                    <button class="tool-btn" id="notesBtn" title="ä¸ªäººç¬”è®°" onclick="showNotes()">
                        <span class="tool-icon">ğŸ“</span>
                        <span class="tool-label">ç¬”è®°</span>
                    </button>
                    
                    <button class="tool-btn" id="historyBtn" title="æ¸¸æˆå†å²" onclick="showHistory()">
                        <span class="tool-icon">ğŸ“š</span>
                        <span class="tool-label">å†å²</span>
                    </button>
                    
                    <button class="tool-btn" id="settingsBtn" title="æ¸¸æˆè®¾ç½®" onclick="showSettings()">
                        <span class="tool-icon">âš™ï¸</span>
                        <span class="tool-label">è®¾ç½®</span>
                    </button>
                    
                    <button class="tool-btn emergency" id="emergencyBtn" title="ç´§æ€¥å‘¼å«" onclick="emergencyCall()">
                        <span class="tool-icon">ğŸš¨</span>
                        <span class="tool-label">ç´§æ€¥</span>
                    </button>
                    
                    <button class="tool-btn" id="exitBtn" title="é€€å‡ºæ¸¸æˆ" onclick="exitGame()">
                        <span class="tool-icon">ğŸšª</span>
                        <span class="tool-label">é€€å‡º</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ¨¡æ€æ¡†å®¹å™¨ -->
<div id="modalContainer"></div>

<!-- éŸ³æ•ˆå…ƒç´  -->
<audio id="suspenseAudio" preload="auto" loop>
    <!-- å¯ä»¥æ·»åŠ æ‚¬ç–‘èƒŒæ™¯éŸ³ä¹ -->
</audio>

<!-- è¿›åº¦æ¨¡æ€æ¡† -->
<div id="progressModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3>ğŸ­ æ­£åœ¨å‡†å¤‡æ¸¸æˆ...</h3>
        <div class="progress-container">
            <div class="progress-bar-full">
                <div class="progress-bar-fill" id="gameProgressBar"></div>
            </div>
            <div class="progress-text" id="progressText">åˆå§‹åŒ–ä¸­...</div>
        </div>
        <div class="progress-details" id="progressDetails">
            <div class="detail-item">
                <span class="detail-label">ğŸ“ å‰§æœ¬ç”Ÿæˆï¼š</span>
                <span class="detail-status" id="scriptStatus">ç­‰å¾…ä¸­</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆï¼š</span>
                <span class="detail-status" id="imageStatus">ç­‰å¾…ä¸­</span>
            </div>
            <div class="detail-item">
                <span class="detail-label">ğŸ® æ¸¸æˆå‡†å¤‡ï¼š</span>
                <span class="detail-status" id="gameStatus">ç­‰å¾…ä¸­</span>
            </div>
        </div>
        <div class="progress-actions">
            <button class="mystery-btn" id="skipWaitBtn" onclick="skipWait()" style="display: none;">
                è·³è¿‡ç­‰å¾…
            </button>
        </div>
    </div>
</div>

<script>
// å…¨å±€æ¸¸æˆçŠ¶æ€
window.gameState = {
    user: {
        id: {{ user.id }},
        username: "{{ user.username | safe }}",
        nickname: "{{ user.nickname | safe }}",
        avatar: "{{ user.avatar | safe if user.avatar else '' }}"
    },
    currentCharacter: null,
    gameSession: null,
    gameMode: 'waiting', // waiting, character_select, playing, finished
    currentChapter: 0,
    totalChapters: 0,
    players: {},
    clues: [],
    notes: '',
    inputMode: 'speak',
    config: {
        scriptSource: 'generate',
        localScriptPath: '',
        generateImages: true,
        waitForCompletion: true
    }
};

// åˆå§‹åŒ–æ¸¸æˆç•Œé¢
document.addEventListener('DOMContentLoaded', function() {
    initializeGameInterface();
    setupGameEvents();
    checkGameStatus();
});
</script>

<script src="{{ url_for('static', filename='murder_mystery_v2.js') }}"></script>
{% endblock %}

{% block extra_js %}
<script>
// é¡µé¢ç‰¹å®šçš„åˆå§‹åŒ–ä»£ç 
document.addEventListener('DOMContentLoaded', function() {
    // å¯åŠ¨èƒŒæ™¯éŸ³æ•ˆï¼ˆå¦‚æœç”¨æˆ·å…è®¸ï¼‰
    const audio = document.getElementById('suspenseAudio');
    if (audio) {
        audio.volume = 0.1; // ä½éŸ³é‡
        // ç”¨æˆ·äº¤äº’åæ‰èƒ½æ’­æ”¾éŸ³é¢‘
        document.addEventListener('click', function() {
            audio.play().catch(e => console.log('éŸ³é¢‘æ’­æ”¾å¤±è´¥:', e));
        }, { once: true });
    }
    
    // æ·»åŠ é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Ctrl+Enter å‘é€æ¶ˆæ¯
        if (e.ctrlKey && e.key === 'Enter') {
            sendMessage();
        }
        // Esc å…³é—­æ¨¡æ€æ¡†
        if (e.key === 'Escape') {
            closeAllModals();
        }
    });
    
    // é…ç½®é¢æ¿åˆ‡æ¢
    document.querySelectorAll('input[name="scriptSource"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const localPathGroup = document.getElementById('localPathGroup');
            if (this.value === 'local') {
                localPathGroup.style.display = 'block';
            } else {
                localPathGroup.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}