{% extends "base.html" %}

{% block title %}å‰§æœ¬æ€æ¸¸æˆ - ä¸¥æ ¼æµç¨‹ç‰ˆ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='game_flow_v3.css') }}">
<script src="https://cdn.jsdelivr.net/npm/marked@5.1.1/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
{% endblock %}

{% block content %}
<!-- æ‚¬ç–‘èƒŒæ™¯ -->
<div class="mystery-bg"></div>
<div class="fog-overlay"></div>

<div class="game-container">
    <!-- æ¸¸æˆçŠ¶æ€æ  -->
    <div class="game-status-bar">
        <div class="game-info">
            <div class="story-title" id="storyTitle">ğŸ“š ç­‰å¾…å‰§æœ¬åŠ è½½...</div>
            <div class="phase-info">
                <span class="current-phase" id="currentPhase">å‡†å¤‡é˜¶æ®µ</span>
                <span class="chapter-info" id="chapterInfo">ç¬¬0ç« </span>
                <span class="cycle-info" id="cycleInfo">å¾ªç¯ 0/3</span>
                <div class="timer-container">
                    <span class="timer" id="phaseTimer">--:--</span>
                    <div class="timer-bar">
                        <div class="timer-fill" id="timerFill"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="game-controls">
            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            {% if current_user.is_authenticated %}
            <div class="user-info">
                {% if current_user.avatar %}
                <img src="{{ current_user.avatar }}" alt="å¤´åƒ" class="user-avatar">
                {% else %}
                <i class="fas fa-user-circle"></i>
                {% endif %}
                <span class="user-name">{{ current_user.nickname }}</span>
                <a href="{{ url_for('logout') }}" class="logout-btn" title="é€€å‡ºç™»å½•">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
            {% else %}
            <div class="auth-links">
                <a href="{{ url_for('login') }}" class="auth-link">
                    <i class="fas fa-sign-in-alt"></i> ç™»å½•
                </a>
                <a href="{{ url_for('register') }}" class="auth-link">
                    <i class="fas fa-user-plus"></i> æ³¨å†Œ
                </a>
            </div>
            {% endif %}
            <button class="control-btn" id="configBtn" onclick="showGameConfig()">âš™ï¸ é…ç½®</button>
            <button class="control-btn" id="newGameBtn" onclick="startNewGame()">ğŸ­ æ–°æ¸¸æˆ</button>
            <button class="control-btn" id="loadGameBtn" onclick="loadExistingGame()">ğŸ“‚ åŠ è½½æ¸¸æˆ</button>
        </div>
    </div>

    <!-- æ¸¸æˆé…ç½®é¢æ¿ -->
    <div class="config-panel" id="configPanel" style="display: none;">
        <h3>ğŸ® æ¸¸æˆé…ç½®</h3>
        <div class="config-form">
            <div class="config-group">
                <label>å‰§æœ¬æ¥æºï¼š</label>
                <div class="radio-group">
                    <label><input type="radio" name="scriptSource" value="generate" checked> ğŸ†• AIç”Ÿæˆæ–°å‰§æœ¬</label>
                    <label><input type="radio" name="scriptSource" value="local"> ğŸ“ ä½¿ç”¨æœ¬åœ°å‰§æœ¬</label>
                </div>
            </div>
            <div class="config-group" id="localPathGroup" style="display: none;">
                <label>æœ¬åœ°å‰§æœ¬è·¯å¾„ï¼š</label>
                <input type="text" id="localScriptPath" placeholder="è¾“å…¥å‰§æœ¬æ–‡ä»¶å¤¹è·¯å¾„">
                <button class="browse-btn" onclick="browseLocalScripts()">æµè§ˆ</button>
            </div>
            <div class="config-group">
                <label><input type="checkbox" id="generateImages" checked> ğŸ–¼ï¸ ç”Ÿæˆè§’è‰²å›¾ç‰‡</label>
            </div>
            <div class="config-actions">
                <button class="control-btn cancel" onclick="hideGameConfig()">å–æ¶ˆ</button>
                <button class="control-btn confirm" onclick="applyGameConfig()">åº”ç”¨é…ç½®</button>
            </div>
        </div>
    </div>

    <!-- è§’è‰²é€‰æ‹©é¢æ¿ -->
    <div class="character-selection" id="characterSelection" style="display: none;">
        <h3>ğŸ­ é€‰æ‹©ä½ çš„è§’è‰²</h3>
        <div class="character-grid" id="characterGrid"></div>
        <button class="control-btn confirm" id="confirmCharacterBtn" onclick="confirmCharacterSelection()" disabled>
            ç¡®è®¤è§’è‰²é€‰æ‹©
        </button>
    </div>

    <!-- ä¸»æ¸¸æˆç•Œé¢ -->
    <div class="game-main" id="gameMain" style="display: none;">
        <!-- å·¦ä¾§ï¼šè§’è‰²åˆ—è¡¨ -->
        <div class="characters-panel">
            <h4>ğŸ‘¥ è§’è‰²åˆ—è¡¨</h4>
            <div class="characters-list" id="charactersList">
                <!-- åŠ¨æ€ç”Ÿæˆè§’è‰²åˆ—è¡¨ -->
            </div>
            
            <h4>ğŸ“Š æ¸¸æˆç»Ÿè®¡</h4>
            <div class="game-stats">
                <div class="stat-item">
                    <span class="stat-label">å½“å‰ç« èŠ‚</span>
                    <span class="stat-value" id="currentChapterStat">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å¾ªç¯æ¬¡æ•°</span>
                    <span class="stat-value" id="currentCycleStat">0/3</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å·²æ”¶é›†çº¿ç´¢</span>
                    <span class="stat-value" id="clueCountStat">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ¸¸æˆæ—¶é•¿</span>
                    <span class="stat-value" id="gameTimeStat">00:00</span>
                </div>
            </div>
        </div>

        <!-- ä¸­å¤®ï¼šæ¶ˆæ¯åŒºåŸŸ -->
        <div class="messages-area">
            <div class="messages-container" id="messagesContainer">
                <!-- æ¬¢è¿æ¶ˆæ¯ -->
                <div class="welcome-message">
                    <h3>ğŸŒ™ æ¬¢è¿æ¥åˆ°å‰§æœ¬æ€æ¸¸æˆ</h3>
                    <p>äº²çˆ±çš„ <strong>{{ user.nickname }}</strong>ï¼Œæ¬¢è¿æ¥åˆ°è¿™ä¸ªå……æ»¡è°œå›¢çš„ä¸–ç•Œã€‚</p>
                    <div class="game-rules">
                        <h4>ğŸ¯ æ¸¸æˆæµç¨‹ï¼š</h4>
                        <ol>
                            <li><strong>ğŸ­ DMå‘è¨€é˜¶æ®µ</strong> - æ¸¸æˆä¸»æŒäººä»‹ç»æƒ…å†µå’Œçº¿ç´¢</li>
                            <li><strong>ğŸ’¬ ç©å®¶å‘è¨€é˜¶æ®µ</strong> - ä½ å¯ä»¥å‘è¨€å¹¶è¯¢é—®å…¶ä»–ç©å®¶</li>
                            <li><strong>ğŸ—£ï¸ ç©å®¶å›ç­”é˜¶æ®µ</strong> - è¢«è¯¢é—®çš„ç©å®¶å›ç­”é—®é¢˜</li>
                        </ol>
                        <p>æ¯ä¸ªç« èŠ‚ä¼šè¿›è¡Œ3æ¬¡å¾ªç¯ï¼Œæœ€åDMæ€»ç»“æ¨è¿›å‰§æƒ…ã€‚</p>
                    </div>
                    <p class="start-tip">ç‚¹å‡»"é…ç½®"è®¾ç½®æ¸¸æˆå‚æ•°ï¼Œç„¶å"æ–°æ¸¸æˆ"å¼€å§‹ä½ çš„æ¨ç†ä¹‹æ—…ï¼</p>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="input-area" id="inputArea" style="display: block;">
                <div class="phase-indicator" id="phaseIndicator">
                    <span class="phase-text" id="phaseText">ç­‰å¾…é˜¶æ®µ</span>
                    <span class="phase-timer" id="phaseTimerDisplay">--:--</span>
                </div>
                
                <!-- å‘è¨€è¾“å…¥ -->
                <div class="speak-input" id="speakInput">
                    <label>ğŸ’¬ ä½ çš„å‘è¨€ï¼š</label>
                    <textarea id="contentInput" placeholder="è¾“å…¥ä½ çš„å‘è¨€å†…å®¹..." rows="3" maxlength="500"></textarea>
                    <div class="char-count" id="charCount">0/500</div>
                </div>

                <!-- è¯¢é—®å…¶ä»–ç©å®¶ -->
                <div class="query-section" id="querySection">
                    <div class="query-list" id="queryList" style="display: none;">
                        <!-- åŠ¨æ€ç”Ÿæˆè¯¢é—®åˆ—è¡¨ -->
                    </div>
                </div>

                <!-- åº•éƒ¨æ§åˆ¶åŒºåŸŸ -->
                <div class="bottom-controls">
                    <button class="query-toggle-btn" id="queryToggleBtn" onclick="toggleQuerySection()">
                        â“ è¯¢é—®å…¶ä»–ç©å®¶
                    </button>
                    <button class="send-btn" id="sendBtn" onclick="prepareSendMessage()">
                        ğŸ“¤ å‘é€
                    </button>
                </div>

                <!-- é˜¶æ®µç¦ç”¨æç¤º -->
                <div class="phase-disabled" id="phaseDisabled" style="display: none;">
                    <div class="disabled-message">
                        <span class="disabled-icon">ğŸš«</span>
                        <span class="disabled-text" id="disabledText">å½“å‰é˜¶æ®µä¸å…è®¸å‘è¨€</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå‰§æœ¬å’Œå·¥å…· -->
        <div class="script-tools-panel">
            <div class="my-script">
                <h4>ğŸ“œ æˆ‘çš„å‰§æœ¬</h4>
                <div class="script-tabs">
                    <button class="script-tab active" data-chapter="current" onclick="showScriptChapter('current')">
                        å½“å‰ç« èŠ‚
                    </button>
                    <button class="script-tab" data-chapter="all" onclick="showScriptChapter('all')">
                        å·²çŸ¥å‰§æœ¬
                    </button>
                </div>
                <div class="script-content" id="scriptContent">
                    <div class="script-placeholder">é€‰æ‹©è§’è‰²åå°†æ˜¾ç¤ºå‰§æœ¬å†…å®¹...</div>
                </div>
            </div>

            <div class="game-tools">
                <h4>ğŸ”§ æ¸¸æˆå·¥å…·</h4>
                <div class="tools-grid">
                    <button class="tool-btn" onclick="showClues()">
                        <span class="tool-icon">ğŸ”</span>
                        <span class="tool-text">çº¿ç´¢</span>
                        <span class="badge" id="clueBadge">0</span>
                    </button>
                    <button class="tool-btn" onclick="showNotes()">
                        <span class="tool-icon">ğŸ“</span>
                        <span class="tool-text">ç¬”è®°</span>
                    </button>
                    <button class="tool-btn" onclick="showHistory()">
                        <span class="tool-icon">ğŸ“š</span>
                        <span class="tool-text">å†å²</span>
                    </button>
                    <button class="tool-btn" onclick="showSettings()">
                        <span class="tool-icon">âš™ï¸</span>
                        <span class="tool-text">è®¾ç½®</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤å‘é€æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="sendConfirmModal" style="display: none;">
    <div class="modal-content">
        <h3>ğŸ“¤ ç¡®è®¤å‘é€</h3>
        <div class="confirm-content">
            <div class="confirm-section">
                <h4>ğŸ’¬ ä½ çš„å‘è¨€ï¼š</h4>
                <div class="confirm-preview" id="contentPreview"></div>
            </div>
            <div class="confirm-section" id="queriesPreview" style="display: none;">
                <h4>â“ è¯¢é—®å…¶ä»–ç©å®¶ï¼š</h4>
                <div class="queries-list" id="queriesListPreview"></div>
            </div>
        </div>
        <div class="modal-actions">
            <button class="control-btn cancel" onclick="cancelSendMessage()">å–æ¶ˆ</button>
            <button class="control-btn confirm" onclick="confirmSendMessage()">ç¡®è®¤å‘é€</button>
        </div>
    </div>
</div>

<!-- è¿›åº¦æ¨¡æ€æ¡† -->
<div class="modal-overlay" id="progressModal" style="display: none;">
    <div class="modal-content">
        <h3>ğŸ­ æ­£åœ¨å‡†å¤‡æ¸¸æˆ...</h3>
        <div class="progress-info">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">åˆå§‹åŒ–ä¸­...</div>
        </div>
        <div class="progress-details">
            <div class="progress-item">
                <span class="progress-label">ğŸ“ å‰§æœ¬ç”Ÿæˆï¼š</span>
                <span class="progress-status" id="scriptStatus">ç­‰å¾…ä¸­</span>
            </div>
            <div class="progress-item">
                <span class="progress-label">ğŸ–¼ï¸ å›¾ç‰‡ç”Ÿæˆï¼š</span>
                <span class="progress-status" id="imageStatus">ç­‰å¾…ä¸­</span>
            </div>
            <div class="progress-item">
                <span class="progress-label">ğŸ® æ¸¸æˆå‡†å¤‡ï¼š</span>
                <span class="progress-status" id="gameStatus">ç­‰å¾…ä¸­</span>
            </div>
        </div>
    </div>
</div>

<!-- å…¨å±€çŠ¶æ€ -->
<script>
window.gameState = {
    user: {
        id: {{ user.id }},
        username: "{{ user.username | safe }}",
        nickname: "{{ user.nickname | safe }}"
    },
    gameSession: null,
    currentCharacter: null,
    gameMode: 'waiting', // waiting, character_select, playing
    currentPhase: 'waiting', // waiting, dm_speak, player_speak, player_answer, dm_summary
    currentChapter: 0,
    currentCycle: 0,
    totalCycles: 3,
    phaseTimer: null,
    phaseTimeLeft: 0,
    characters: [],
    pendingContent: '',
    pendingQueries: {},
    config: {
        scriptSource: 'generate',
        localScriptPath: '',
        generateImages: true
    }
};
</script>

<script src="{{ url_for('static', filename='game_flow_v3.js') }}"></script>
{% endblock %}

{% block extra_js %}
<script>
// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–æ¸¸æˆç•Œé¢
    window.gameController = new GameFlowController();
    
    // è®¾ç½®å¿«æ·é”®
    document.addEventListener('keydown', function(e) {
        // Ctrl+Enter å‘é€æ¶ˆæ¯
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            if (window.gameController) {
                window.gameController.prepareSendMessage();
            }
        }
        // Esc å…³é—­æ¨¡æ€æ¡†
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.style.display = 'none';
            });
        }
    });
    
    // é…ç½®å˜æ›´ç›‘å¬
    document.querySelectorAll('input[name="scriptSource"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const localPathGroup = document.getElementById('localPathGroup');
            localPathGroup.style.display = this.value === 'local' ? 'block' : 'none';
        });
    });
    
    // å­—ç¬¦è®¡æ•°
    const contentInput = document.getElementById('contentInput');
    if (contentInput) {
        contentInput.addEventListener('input', function() {
            const charCount = document.getElementById('charCount');
            const length = this.value.length;
            charCount.textContent = `${length}/500`;
            
            if (length > 450) {
                charCount.style.color = '#FF6B6B';
            } else if (length > 350) {
                charCount.style.color = '#FFA500';
            } else {
                charCount.style.color = '#888';
            }
        });
        
        // æ·»åŠ Ctrl+Enterå¿«æ·é”®å‘é€åŠŸèƒ½
        contentInput.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ¢è¡Œè¡Œä¸º
                
                // æ£€æŸ¥å‘é€æŒ‰é’®æ˜¯å¦å¯ç”¨
                const sendBtn = document.getElementById('sendBtn');
                if (sendBtn && !sendBtn.disabled && sendBtn.style.display !== 'none') {
                    // è§¦å‘å‘é€é€»è¾‘ï¼Œä¸ç‚¹å‡»å‘é€æŒ‰é’®æ•ˆæœç›¸åŒ
                    prepareSendMessage();
                }
            }
        });
    }
});
</script>
{% endblock %}