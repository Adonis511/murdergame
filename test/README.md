# æµ‹è¯•å’Œæ¼”ç¤ºè„šæœ¬ç›®å½•

è¿™ä¸ªç›®å½•åŒ…å«äº†é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­åˆ›å»ºçš„å„ç§æµ‹è¯•å’Œæ¼”ç¤ºè„šæœ¬ã€‚

## ğŸ“ æ–‡ä»¶è¯´æ˜

### ğŸ§ª æµ‹è¯•è„šæœ¬

#### `test_player.py`
- **ç”¨é€”**: æµ‹è¯•PlayerAgentçš„åŠŸèƒ½
- **åŠŸèƒ½**: 
  - æµ‹è¯•queryæ–¹æ³•ï¼ˆä¸»åŠ¨å‘è¨€ï¼Œè¿”å›JSONæ ¼å¼ï¼‰
  - æµ‹è¯•responseæ–¹æ³•ï¼ˆè¢«åŠ¨å›åº”ï¼‰
  - å¤šåœºæ™¯æµ‹è¯•
- **è¿è¡Œ**: `python test/test_player.py`
- **è¿”å›æ ¼å¼**: 
  ```json
  {
    "content": "å‘è¨€å†…å®¹ï¼ˆmarkdownæ ¼å¼ï¼‰",
    "query": {"äººå": "é—®é¢˜å†…å®¹"}
  }
  ```

#### `test_dm_image.py`
- **ç”¨é€”**: æµ‹è¯•DMAgentçš„å›¾ç‰‡ç”ŸæˆåŠŸèƒ½
- **åŠŸèƒ½**:
  - æµ‹è¯•å•å¼ å›¾ç‰‡ç”Ÿæˆ
  - æµ‹è¯•è§’è‰²å›¾ç‰‡ç”Ÿæˆ
  - æµ‹è¯•çº¿ç´¢å›¾ç‰‡ç”Ÿæˆ
  - é”™è¯¯å¤„ç†å’Œç¯å¢ƒæ£€æŸ¥
- **è¿è¡Œ**: `python test/test_dm_image.py`
- **ä¾èµ–**: é˜¿é‡Œäº‘ç™¾ç‚¼APIå¯†é’¥

#### `test_game.py`
- **ç”¨é€”**: æµ‹è¯•Gameç±»çš„å®Œæ•´åŠŸèƒ½
- **åŠŸèƒ½**:
  - æµ‹è¯•åŠ¨æ€å‰§æœ¬ç”Ÿæˆ + å›¾ç‰‡ç”Ÿæˆ
  - æµ‹è¯•ç°æœ‰å‰§æœ¬åŠ è½½
  - æµ‹è¯•é€‰æ‹©æ€§å›¾ç‰‡ç”Ÿæˆ
  - é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µ
- **è¿è¡Œ**: `python test/test_game.py`
- **ä¾èµ–**: DMAgentå’ŒPlayerAgent

### ğŸ¯ æ¼”ç¤ºè„šæœ¬

#### `demo_json_query.py`
- **ç”¨é€”**: æ¼”ç¤ºPlayerAgentçš„JSONæ ¼å¼è¾“å‡ºåŠŸèƒ½
- **åŠŸèƒ½**:
  - å±•ç¤ºJSONæ ¼å¼çš„åŸºæœ¬ç”¨æ³•
  - å¤šåœºæ™¯æ¼”ç¤º
  - JSONç»“æ„è¯´æ˜
- **è¿è¡Œ**: `python test/demo_json_query.py`

#### `demo_response_api.py`
- **ç”¨é€”**: æ¼”ç¤ºPlayerAgent.response()æ–¹æ³•çš„æ–°API
- **åŠŸèƒ½**:
  - å±•ç¤ºå¿…é€‰å‚æ•°queryå’Œquery_playerçš„ç”¨æ³•
  - ä¸åŒé—®é¢˜ç±»å‹çš„é’ˆå¯¹æ€§å›åº”æ¼”ç¤º
  - APIå˜æ›´è¯´æ˜å’Œé”™è¯¯å¤„ç†
- **è¿è¡Œ**: `python test/demo_response_api.py`

## ğŸš€ å¿«é€Ÿå¼€å§‹

### è¿è¡Œæ‰€æœ‰æµ‹è¯•
```bash
# æµ‹è¯•PlayerAgentåŠŸèƒ½
python test/test_player.py

# æ¼”ç¤ºJSONæ ¼å¼è¾“å‡º
python test/demo_json_query.py

# æ¼”ç¤ºresponseæ–¹æ³•æ–°API
python test/demo_response_api.py

# æµ‹è¯•å›¾ç‰‡ç”ŸæˆåŠŸèƒ½
python test/test_dm_image.py

# æµ‹è¯•æ¸¸æˆç±»åŠŸèƒ½
python test/test_game.py
```

### æµ‹è¯•ç‰¹å®šåŠŸèƒ½
```bash
# è¿›å…¥æµ‹è¯•ç›®å½•
cd test

# è¿è¡Œå•ä¸ªæµ‹è¯•
python test_player.py
python demo_json_query.py
python demo_response_api.py
python test_dm_image.py
python test_game.py
```

## ğŸ“Š æµ‹è¯•è¦†ç›–

- âœ… **PlayerAgent.query()** - ä¸»åŠ¨å‘è¨€åŠŸèƒ½ï¼ˆè¿”å›JSONæ ¼å¼ï¼‰
- âœ… **PlayerAgent.response()** - è¢«åŠ¨å›åº”åŠŸèƒ½ï¼ˆå­—ç¬¦ä¸²æ ¼å¼ï¼‰
  - å¿…é¡»æŒ‡å®šå…·ä½“é—®é¢˜å’Œæé—®è€…
  - æ ¹æ®å…·ä½“é—®é¢˜å’Œæé—®è€…ç”Ÿæˆç²¾å‡†å›åº”
- âœ… **DMAgent.gen_image()** - å›¾ç‰‡ç”ŸæˆåŠŸèƒ½ï¼ˆé˜¿é‡Œäº‘ç™¾ç‚¼ï¼‰
  - å¼‚æ­¥ä»»åŠ¡æäº¤å’Œè½®è¯¢
  - è§’è‰²å›¾ç‰‡ç”Ÿæˆ
  - çº¿ç´¢å›¾ç‰‡ç”Ÿæˆ
  - æœ¬åœ°å›¾ç‰‡ä¸‹è½½å’Œä¿å­˜
- âœ… **Gameç±»åŠŸèƒ½** - å®Œæ•´æ¸¸æˆæµç¨‹
  - åŠ¨æ€å‰§æœ¬ç”Ÿæˆå’Œç°æœ‰å‰§æœ¬åŠ è½½
  - è‡ªåŠ¨è§’è‰²å’Œçº¿ç´¢å›¾ç‰‡ç”Ÿæˆ
  - å›¾ç‰‡ä¿¡æ¯ç®¡ç†å’Œä¿å­˜
  - PlayerAgenté›†æˆ
- âœ… **JSONæ ¼å¼è¾“å‡º** - ç»“æ„åŒ–æ•°æ®è¿”å›
- âœ… **å¤šåœºæ™¯æµ‹è¯•** - ä¸åŒè§’è‰²çš„è¡Œä¸ºéªŒè¯
- âœ… **é”™è¯¯å¤„ç†** - å¼‚å¸¸æƒ…å†µçš„å¤„ç†

## ğŸ’¡ ä½¿ç”¨è¯´æ˜

### PlayerAgentåŸºæœ¬ç”¨æ³•
```python
from player_agent import PlayerAgent

# åˆ›å»ºç©å®¶
player = PlayerAgent("æå")

# ä¸»åŠ¨å‘è¨€ï¼ˆè¿”å›JSONï¼‰
result = player.query(scripts, chat_history)
content = result['content']
queries = result['query']

# è¢«åŠ¨å›åº”ï¼ˆè¿”å›å­—ç¬¦ä¸²ï¼Œå¿…é¡»æŒ‡å®šé—®é¢˜å’Œæé—®è€…ï¼‰
response = player.response(scripts, chat_history, 
                          query="ä½ æ˜¨æ™šåœ¨åšä»€ä¹ˆï¼Ÿ", 
                          query_player="æå")
```

### DMAgentåŸºæœ¬ç”¨æ³•
```python
from dm_agent import DMAgent

# åˆ›å»ºDM
dm = DMAgent()

# ç”Ÿæˆå‰§æœ¬
script = dm.gen_script()

# ç”Ÿæˆå›¾ç‰‡
image_result = dm.gen_image("ä¸€é—´è±ªåçš„ä¹¦æˆ¿ï¼Œæ·±è‰²æœ¨è´¨ä¹¦æ¡Œï¼Œæ˜æš—çš„ç¯å…‰")

if image_result and image_result.get('success'):
    print(f"å›¾ç‰‡URL: {image_result['url']}")
    print(f"æœ¬åœ°æ–‡ä»¶: {image_result['local_path']}")
else:
    print(f"ç”Ÿæˆå¤±è´¥: {image_result.get('error_message')}")
```

### Gameç±»åŸºæœ¬ç”¨æ³•
```python
from game import Game

# æ–¹å¼1: åŠ¨æ€ç”Ÿæˆå‰§æœ¬å¹¶ç”Ÿæˆæ‰€æœ‰å›¾ç‰‡ï¼ˆå®Œæ•´æµç¨‹ï¼‰
game1 = Game()

# æ–¹å¼2: ä½¿ç”¨ç°æœ‰å‰§æœ¬ï¼Œä¸ç”Ÿæˆå›¾ç‰‡
game2 = Game(script_path='log/250108123456/script.json', generate_images=False)

# æ–¹å¼3: ä»…ç”Ÿæˆè§’è‰²å›¾ç‰‡
game3 = Game(generate_images=False)
game3._generate_character_images()

# è·å–æ¸¸æˆä¿¡æ¯
game_dir = game1.get_game_directory()  # è·å–æ¸¸æˆç›®å½•
character_image = game1.get_character_image('è§’è‰²å')
clue_images = game1.get_clue_images(1)  # ç¬¬1ç« çº¿ç´¢
all_images = game1.get_all_character_images()

# æ¸¸æˆä¿¡æ¯è‡ªåŠ¨ä¿å­˜ä¸º game_info.json
# åŒ…å«å®Œæ•´çš„ç»Ÿè®¡å’Œæ–‡ä»¶ç»“æ„ä¿¡æ¯

# è®¿é—®å‰§æœ¬å’Œç©å®¶ä¿¡æ¯
print(f"å‰§æœ¬æ ‡é¢˜: {game1.script['title']}")
print(f"è§’è‰²åˆ—è¡¨: {game1.script['characters']}")
print(f"æ¸¸æˆç›®å½•: {game1.get_game_directory()}")
print(f"ç©å®¶ä»£ç†: {[agent.name for agent in game1.player_agents]}")

# æ–°çš„ç›®å½•ç»“æ„
# log/YYMMDDhhmmss/
# â”œâ”€â”€ script.json
# â”œâ”€â”€ game_info.json  
# â””â”€â”€ imgs/
#     â”œâ”€â”€ è§’è‰²å.png
#     â””â”€â”€ clue-ch1-1.png
```

### JSONæ ¼å¼è¯´æ˜
```json
{
  "content": "æˆ‘è§‰å¾—æˆ‘ä»¬éœ€è¦åˆ†æä¸€ä¸‹æ—¶é—´çº¿...",
  "query": {
    "ç‹å¼º": "ä½ æ˜¨æ™šå…·ä½“åœ¨å“ªé‡Œï¼Ÿ",
    "å¼ é›ª": "ä½ æœ‰æ³¨æ„åˆ°å¼‚å¸¸å—ï¼Ÿ"
  }
}
```

## ğŸ”§ å¼€å‘è¯´æ˜

### æ·»åŠ æ–°æµ‹è¯•
1. åœ¨testç›®å½•ä¸‹åˆ›å»ºæ–°çš„æµ‹è¯•æ–‡ä»¶
2. éµå¾ªå‘½åè§„èŒƒï¼š`test_*.py` æˆ– `demo_*.py`
3. åŒ…å«å¿…è¦çš„é”™è¯¯å¤„ç†å’Œç»“æœéªŒè¯
4. æ›´æ–°æœ¬READMEæ–‡ä»¶

### æµ‹è¯•ç¯å¢ƒè¦æ±‚
- Python 3.7+
- å·²å®‰è£…é¡¹ç›®ä¾èµ– (`pip install -r requirements.txt`)
- é…ç½®äº†OpenAI APIå¯†é’¥
- ç½‘ç»œè¿æ¥æ­£å¸¸

## ğŸ“ å†å²è®°å½•

- **2025-01-08**: åˆ›å»ºtestç›®å½•ï¼Œç§»åŠ¨æµ‹è¯•è„šæœ¬
- **2025-01-08**: ä¿®æ”¹PlayerAgent.query()è¿”å›JSONæ ¼å¼
- **2025-01-08**: æ·»åŠ demo_json_query.pyæ¼”ç¤ºè„šæœ¬
- **2025-01-08**: ä¼˜åŒ–æµ‹è¯•è„šæœ¬çš„è¾“å‡ºæ ¼å¼å’Œé”™è¯¯å¤„ç†
- **2025-01-08**: ä¸ºPlayerAgent.response()æ–¹æ³•æ·»åŠ queryå’Œquery_playerå‚æ•°ï¼ˆå¿…é€‰ï¼‰
- **2025-01-08**: å®ŒæˆDMAgent.gen_image()å›¾ç‰‡ç”ŸæˆåŠŸèƒ½ï¼ˆé˜¿é‡Œäº‘ç™¾ç‚¼ï¼‰
- **2025-01-08**: å¢å¼ºGameç±»ï¼Œæ”¯æŒå‰§æœ¬åŠ è½½å’Œå®Œæ•´å›¾ç‰‡ç”Ÿæˆæµç¨‹
- **2025-01-08**: é‡æ„æ–‡ä»¶å­˜å‚¨ç»“æ„ï¼Œä½¿ç”¨å¸¦æ—¶é—´æˆ³çš„æ¸¸æˆç›®å½•

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ImportError: No module named 'openai'**
   - è§£å†³: è¿è¡Œ `python install.py` å®‰è£…ä¾èµ–

2. **APIè°ƒç”¨å¤±è´¥**
   - æ£€æŸ¥config.pyä¸­çš„API_KEYé…ç½®
   - ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸

3. **JSONè§£æé”™è¯¯**
   - è¿™æ˜¯æ­£å¸¸ç°è±¡ï¼Œè„šæœ¬æœ‰å®¹é”™æœºåˆ¶
   - ä¼šè‡ªåŠ¨è¿”å›é»˜è®¤æ ¼å¼

4. **å›¾ç‰‡ç”Ÿæˆå¤±è´¥**
   - æ£€æŸ¥é˜¿é‡Œäº‘ç™¾ç‚¼APIå¯†é’¥æ˜¯å¦æ­£ç¡®é…ç½®
   - ç¡®è®¤ç½‘ç»œè¿æ¥ç¨³å®šï¼Œå¯ä»¥è®¿é—®dashscope.aliyuncs.com
   - æ£€æŸ¥æç¤ºè¯æ˜¯å¦ç¬¦åˆå†…å®¹å®‰å…¨è¦æ±‚

5. **å›¾ç‰‡ç”Ÿæˆè¶…æ—¶**
   - é»˜è®¤è¶…æ—¶æ—¶é—´ä¸º300ç§’ï¼Œå¯ä»¥è°ƒæ•´max_wait_timeå‚æ•°
   - ç½‘ç»œè¾ƒæ…¢æ—¶å»ºè®®å¢åŠ è½®è¯¢é—´éš”poll_interval

6. **å›¾ç‰‡ä¸‹è½½å¤±è´¥**
   - æ£€æŸ¥æœ¬åœ°imagesç›®å½•æ˜¯å¦æœ‰å†™å…¥æƒé™
   - ç¡®è®¤ç£ç›˜ç©ºé—´å……è¶³

### è°ƒè¯•æç¤º
- ä½¿ç”¨ `python -v test/test_player.py` æŸ¥çœ‹è¯¦ç»†è¾“å‡º
- ä½¿ç”¨ `python test/test_dm_image.py` æµ‹è¯•å›¾ç‰‡ç”ŸæˆåŠŸèƒ½
- ä½¿ç”¨ `python test/test_game.py` æµ‹è¯•å®Œæ•´æ¸¸æˆæµç¨‹
- ä½¿ç”¨ `python demo_new_structure.py` æŸ¥çœ‹æ–°ç›®å½•ç»“æ„æ¼”ç¤º
- æ£€æŸ¥logç›®å½•ä¸­çš„æ¸¸æˆä¼šè¯
  - `log/YYMMDDhhmmss/` - æ¸¸æˆä¼šè¯ç›®å½•
  - `script.json` - å‰§æœ¬æ–‡ä»¶
  - `game_info.json` - æ¸¸æˆä¿¡æ¯å’Œç»Ÿè®¡
- æ£€æŸ¥imgsç›®å½•ä¸­çš„ç”Ÿæˆå›¾ç‰‡
  - è§’è‰²å›¾ç‰‡å‘½å: `è§’è‰²å.png`
  - çº¿ç´¢å›¾ç‰‡å‘½å: `clue-chç« èŠ‚-åºå·.png`
- ç¡®è®¤å‰§æœ¬æ–‡ä»¶æ ¼å¼æ­£ç¡®
- å›¾ç‰‡ç”Ÿæˆä»»åŠ¡IDå¯ç”¨äºè¿½è¸ªé—®é¢˜

---

ğŸ“ **éœ€è¦å¸®åŠ©?** è¯·å‚è€ƒé¡¹ç›®æ ¹ç›®å½•çš„README.mdæˆ–SETUP_GUIDE.mdæ–‡ä»¶ã€‚