# AI剧本杀游戏模拟测试说明

## 概述

`test_ai_game_simulation.py` 是一个完整的AI剧本杀游戏模拟脚本，用于验证游戏的AI系统。它会动态获取剧本中的所有角色，并为每个角色创建AI代理进行完整的游戏模拟。

## 主要功能

### 🎭 完整的游戏流程测试
- **4个章节**的完整测试
- **DM引导** + **AI玩家互动** + **章节总结**
- **游戏开始** 到 **最终结局** 的完整体验

### 🤖 动态AI角色互动
- **自动获取剧本中的所有角色**，不预设特定人名
- **为每个角色创建AI代理**进行游戏
- 真实的 **AI询问** 和 **AI回应**
- 显示每个AI的 **完整发言内容**
- **适应任意数量的角色** (2个以上)

### 📞 方法调用记录
严格限制只调用以下三个核心方法：
- `DMAgent.speak()` - DM发言和工具展示
- `PlayerAgent.query()` - AI主动发言和询问
- `PlayerAgent.response()` - AI回应其他玩家

### 📊 详细统计报告
- 每个方法的调用次数和时间
- 每个AI的参与度统计
- 完整的聊天历史记录

## 使用方法

### 方式1: 脚本内配置
编辑 `test_ai_game_simulation.py` 顶部的配置区域：

```python
# 生成新剧本（AI自动生成角色）
GAME_PATH = None

# 或使用现有剧本（从剧本中获取角色）
GAME_PATH = "log/250805110930"
```

然后运行：
```bash
python test_ai_game_simulation.py
```

### 方式2: 命令行参数

```bash
# 生成新剧本
python test_ai_game_simulation.py --new

# 使用指定剧本
python test_ai_game_simulation.py --path log/250805110930

# 查看帮助
python test_ai_game_simulation.py --help
```

## 测试输出示例

### DM发言展示
```
🎭 DM开始第1章...
✅ DM开场发言成功 (392 字符)
💬 DM发言内容：
   欢迎来到豪门血案！今晚，林家庄园将发生一场震惊的谋杀案...
🔧 DM展示了 2 个工具:
   1. show_clue: 书房的血迹
   2. show_clue: 撕碎的信纸
```

### AI玩家互动展示
```
👤 角色A 的游戏回合...
💬 角色A 发言内容：
   根据我刚才看到的情况，我觉得我们需要仔细分析这些线索...
❓ 角色A 的询问:
   向 角色B: 你昨晚什么时候到达现场的？
   向 角色C: 你有没有听到什么异常的声音？

💬 角色B 回应内容：
   我是昨晚8点左右到的，当时很安静...

🤖 参与AI角色: 4个 (动态从剧本获取)
📖 将模拟完整的 4 个章节
```

### 方法调用统计
```
📊 方法调用统计报告
🎭 DM.speak() 调用次数: 9
   ✅ 12:34:56 - 第1章开始
   ✅ 12:35:23 - 第1章结束
   ...

🗣️ PlayerAgent.query() 调用次数: 12
   ✅ 12:35:01 - 林慕白
   ✅ 12:35:08 - 苏婉清
   ...

💬 PlayerAgent.response() 调用次数: 8
   ✅ 12:35:02 - 苏婉清 -> 林慕白
   ✅ 12:35:09 - 赵子轩 -> 苏婉清
   ...

👥 AI参与度统计:
   角色A: 发言4次, 回应3次, 被询问2次
   角色B: 发言4次, 回应2次, 被询问3次
   角色C: 发言3次, 回应3次, 被询问3次
   角色D: 发言3次, 回应1次, 被询问2次
```

## 配置选项

### 游戏模式
- **新剧本模式**: `GAME_PATH = None` - AI生成全新剧本和角色
- **现有剧本模式**: `GAME_PATH = "路径"` - 加载已有剧本和角色

### 角色获取
- **动态角色获取**: 自动从剧本中读取所有角色
- **全角色参与**: 为每个角色创建AI代理
- **无预设限制**: 适应任意数量的角色（2个以上）
- **智能轮换**: 确保每个AI都有充分的参与机会

### 测试范围
- 所有章节的完整测试（数量由剧本决定）
- 智能调整互动轮数（基于角色数量）
- 完整的开始、过程、结束流程

## 注意事项

1. **确保API配置正确** - OpenAI或DashScope的API密钥
2. **网络连接稳定** - AI调用需要网络访问
3. **足够的测试时间** - 完整测试约需5-10分钟
4. **日志文件保存** - 测试结果会保存在游戏目录中

## 故障排除

### 常见错误
- `格式化错误`: player_agent.py的提示词问题
- `路径不存在`: 检查GAME_PATH设置
- `API调用失败`: 检查网络和API密钥

### 调试方法
- 查看详细的错误堆栈
- 检查方法调用统计
- 验证游戏路径的文件结构

## 扩展使用

### 调整角色参与逻辑
修改 `simulate_chapter_discussion` 中的角色轮换机制

### 调整测试轮数
修改 `interaction_rounds` 计算逻辑来控制每章的互动轮数

### 自定义统计报告
扩展 `print_method_call_summary` 方法

---

这个测试脚本提供了完整的AI剧本杀游戏模拟功能，能够：

- **动态适应任何剧本**：无论是新生成的还是现有的剧本
- **自动获取所有角色**：不预设角色名称和数量
- **完整AI游戏体验**：所有角色都由AI扮演，进行真实的游戏互动
- **全面系统验证**：确保DM系统和AI代理系统能够正常协作

适用于验证剧本杀游戏AI系统的完整性和可靠性。